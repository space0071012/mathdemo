<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>参数录入（最终版）</title>
<style>
body{font-family:Arial;margin:0;background:#f7f7f7;padding:10px}
h2{margin-top:0}
.section{background:#fff;padding:12px;margin-bottom:10px;border:1px solid #ddd;border-radius:4px}
.row{margin:6px 0;display:flex;align-items:center}
.row label{width:110px;font-size:14px}
.row input,select{height:28px;font-size:14px;padding:0 6px;flex:1}
button{padding:8px 16px;font-size:15px}
.colorSel{width:120px;font-weight:bold}
.optLight{color:#fff;background:var(--c)}
.optDark {color:#000;background:var(--c)}
</style>
</head>
<body>

<h2>动点参数录入（带颜色预览）</h2>

<!-- A 点 -->
<div class="section" id="asec">
  <b>A 点</b>
  <div class="row">
    <label>名称</label>
    <input type="text" id="A_name" value="A" maxlength="4">
  </div>
  <div class="row"><label>初始位置</label><input type="number" id="A_start" value="-1" step="1"></div>
  <div class="row"><label>速度</label><input type="number" id="A_speed" value="1" min="0" step="0.1">
    <select id="A_dir"><option value="-1">向左</option><option value="1">向右</option><option value="0">固定</option></select></div>
  <div class="row"><label>颜色</label><select id="A_color" class="colorSel"></select></div>
</div>

<!-- B 点 -->
<div class="section" id="bsec">
  <b>B 点</b>
  <div class="row">
    <label>名称</label>
    <input type="text" id="B_name" value="B" maxlength="4">
  </div>
  <div class="row"><label>初始位置</label><input type="number" id="B_start" value="3" step="1"></div>
  <div class="row"><label>速度</label><input type="number" id="B_speed" value="3" min="0" step="0.1">
    <select id="B_dir"><option value="-1">向左</option><option value="1">向右</option><option value="0">固定</option></select></div>
  <div class="row"><label>颜色</label><select id="B_color" class="colorSel"></select></div>
</div>

<!-- 动态点 -->
<div id="dynamicSecs"></div>

<div class="row">
  <button id="addBtn">+ 添加新点</button>
  <button id="goBtn">生成动画</button>
</div>

<script>
/* 高对比颜色表 */
const COLOR_LIST=[
  {hex:'#FF0000',name:'红'}, {hex:'#00BFFF',name:'亮蓝'}, {hex:'#32CD32',name:'绿'},
  {hex:'#FF8C00',name:'橙'}, {hex:'#BA55D3',name:'紫'}, {hex:'#FFD700',name:'金'},
  {hex:'#FF1493',name:'粉'}, {hex:'#000000',name:'黑'}
];
function makeColorSelect(selId,defaultIdx=0){
  const sel=document.getElementById(selId);
  if(!sel) return;
  sel.innerHTML='';
  COLOR_LIST.forEach((c,i)=>{
    const opt=document.createElement('option');
    opt.value=c.hex; opt.textContent=c.name;
    const rgb=parseInt(c.hex.slice(1),16);
    const r=(rgb>>16)&0xff,g=(rgb>>8)&0xff,b=rgb&0xff;
    const br=(0.299*r+0.587*g+0.114*b)/255;
    opt.className=br>0.5?'optDark':'optLight';
    opt.style.cssText=`background:${c.hex};`;
    if(i===defaultIdx) opt.selected=true;
    sel.appendChild(opt);
  });
}

const $el=(tag,attr={},children=[])=>{
  const e=document.createElement(tag);
  Object.keys(attr).forEach(k=>e[k]=attr[k]);
  children.forEach(c=>e.appendChild(c));
  return e;
};

const LOC_TYPE={abs:{text:'绝对坐标',need:['start']},mid:{text:'两点中点',need:['refAB']},segRatio:{text:'定比分点',need:['refAB','ratio']},offsetAbs:{text:'相对某点偏移',need:['refP','offset']},offsetRatio:{text:'相对某点比例',need:['refP','ratio']}};
const VEL_TYPE={abs:{text:'绝对速度',need:['speed','dir']},same:{text:'与某点同速',need:['refP']},opposite:{text:'与某点反向',need:['refP']},ratio:{text:'与某点成比例',need:['refP','ratio']}};

let pointList=['A','B'];
let counter  =0;

function addSection(){
  const id='P'+counter++;
  const sec=$el('div',{className:'section',id:id});
  const colorIdx = (pointList.length) % COLOR_LIST.length;
  
  sec.innerHTML=`
  <b>点 ${id}</b>
  <div class="row">
    <label>名称</label>
    <input type="text" class="nameIn" value="${id}" maxlength="4">
  </div>
  <div class="row">
    <label>类型</label>
    <select class="typeSel">
      <option value="active">主动点</option>
      <option value="passive">被动点</option>
    </select>
  </div>
  <div class="row color-row">
    <label>颜色</label>
    <select class="colorSel"></select>
  </div>
  <div class="passiveArea" style="display:none">
    <div class="row"><label>位置来源</label><select class="locSel">${opts(LOC_TYPE)}</select></div>
    <div class="locArea"></div>
    <div class="row"><label>速度来源</label><select class="velSel">${opts(VEL_TYPE)}</select></div>
    <div class="velArea"></div>
  </div>
  <div class="activeArea">
    <div class="row"><label>初始位置</label><input type="number" class="startIn" value="0" step="1"></div>
    <div class="row"><label>速度</label><input type="number" class="speedIn" value="1" min="0" step="0.1">
      <select class="dirSel"><option value="-1">向左</option><option value="1">向右</option><option value="0">固定</option></select></div>
  </div>`;
  
  document.getElementById('dynamicSecs').appendChild(sec);
  
  // 生成颜色预览 - 现在只有一个颜色选择器
  const colorSel = sec.querySelector('.colorSel');
  makeColorSelectForElement(colorSel, colorIdx);
  
  bindSecEvents(sec,id);
  pointList.push(id);
}

function makeColorSelectForElement(selElement, defaultIdx=0) {
  selElement.innerHTML = '';
  COLOR_LIST.forEach((c, i) => {
    const opt = document.createElement('option');
    opt.value = c.hex;
    opt.textContent = c.name;
    const rgb = parseInt(c.hex.slice(1), 16);
    const r = (rgb >> 16) & 0xff, g = (rgb >> 8) & 0xff, b = rgb & 0xff;
    const br = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    opt.className = br > 0.5 ? 'optDark' : 'optLight';
    opt.style.cssText = `background:${c.hex};`;
    if (i === defaultIdx) opt.selected = true;
    selElement.appendChild(opt);
  });
}

function opts(obj){
  return Object.keys(obj).map(k=>`<option value="${k}">${obj[k].text}</option>`).join('');
}

function bindSecEvents(sec,id){
  const typeSel=sec.querySelector('.typeSel');
  const pas=sec.querySelector('.passiveArea'),act=sec.querySelector('.activeArea');
  const colorRow = sec.querySelector('.color-row');
  
  typeSel.onchange=()=>{
    const isP=typeSel.value==='passive';
    pas.style.display=isP?'block':'none';
    act.style.display=isP?'none':'block';
  };
  
  const locSel=sec.querySelector('.locSel'),velSel=sec.querySelector('.velSel');
  locSel.onchange=()=>buildSub(locSel,sec.querySelector('.locArea'),LOC_TYPE);
  velSel.onchange=()=>buildSub(velSel,sec.querySelector('.velArea'),VEL_TYPE);
  typeSel.onchange();locSel.onchange();velSel.onchange();
}

function buildSub(sel,area,conf){
  area.innerHTML='';
  const needs=conf[sel.value].need||[];
  needs.forEach(n=>{
    let r;
    if(n==='refAB'||n==='refP') r=buildRef(n);
    else r=buildIn(n);
    area.appendChild(r);
  });
}

function buildRef(type){
  const r=$el('div',{className:'row'});
  const lab=$el('label',{textContent:type==='refAB'?'引用两点':'引用节点'});
  const s=$el('select',{});
  s.innerHTML= type==='refAB'? '<option value="A,B">A,B</option>' : pointList.map(n=>`<option value="${n}">${n}</option>`).join('');
  r.append(lab,s); return r;
}

function buildIn(name){
  const r=$el('div',{className:'row'});
  const lab=$el('label',{textContent:{start:'初始位置',offset:'偏移量',ratio:'比例',speed:'速度',dir:'方向'}[name]||name});
  let i;
  if(name==='dir'){
    i=$el('select',{});
    i.innerHTML='<option value="-1">向左</option><option value="1">向右</option><option value="0">固定</option>';
  }else{
    i=$el('input',{type:'number',step:name==='ratio'?'0.01':'1'});
    if(name==='ratio') i.value='1';
    if(name==='start') i.value='0';
  }
  r.append(lab,i); return r;
}

/* 采集 & 拓扑 */
function collect(){
  const data={
    A:{
      name: document.getElementById('A_name').value.trim() || 'A',
      start:Number(document.getElementById('A_start').value),
      speed:Number(document.getElementById('A_speed').value),
      dir:Number(document.getElementById('A_dir').value),
      color:document.getElementById('A_color').value
    },
    B:{
      name: document.getElementById('B_name').value.trim() || 'B',
      start:Number(document.getElementById('B_start').value),
      speed:Number(document.getElementById('B_speed').value),
      dir:Number(document.getElementById('B_dir').value),
      color:document.getElementById('B_color').value
    }
  };
  
  const secs=document.querySelectorAll('#dynamicSecs .section');
  const edges=[];
  
  secs.forEach(sec=>{
    const id=sec.id;
    const name=sec.querySelector('.nameIn').value.trim()||id;
    const color=sec.querySelector('.colorSel').value;
    const isP=sec.querySelector('.typeSel').value==='passive';
    
    if(isP){
      const locT=sec.querySelector('.locSel').value;
      const velT=sec.querySelector('.velSel').value;
      const locP=getSub(sec,'.locArea',locT,true);
      const velP=getSub(sec,'.velArea',velT,false);
      data[id]={name,color,locationType:locT,locationParam:locP,velocityType:velT,velocityParam:velP};
      Object.values(locP).concat(Object.values(velP)).forEach(v=>{
        if(pointList.includes(v) || v===id) edges.push([v,id]);
      });
    }else{
      data[id]={
        name,
        color,
        start:Number(sec.querySelector('.startIn').value),
        speed:Number(sec.querySelector('.speedIn').value),
        dir:Number(sec.querySelector('.dirSel').value)
      };
    }
  });
  
  // 检查循环依赖
  const allNodes=Object.keys(data);
  const deg={}; allNodes.forEach(n=>deg[n]=0);
  edges.forEach(([u,v])=>deg[v]++);
  let q=allNodes.filter(n=>deg[n]===0);
  let cnt=0;
  while(q.length){ 
    const u=q.pop(); 
    cnt++; 
    edges.forEach(([uu,vv])=>{
      if(uu===u){
        deg[vv]--; 
        if(deg[vv]===0) q.push(vv);
      }
    });
  }
  
  if(cnt!==allNodes.length){ 
    alert('存在循环依赖，请检查被动点引用'); 
    return null; 
  }
  
  return data;
}

function getSub(sec,areaSel,type,isLoc){
  const area=sec.querySelector(areaSel);
  const conf=isLoc?LOC_TYPE[type]:VEL_TYPE[type];
  const needs=conf.need||[];
  const p={};
  needs.forEach(n=>{
    if(n==='refAB') p.refAB=area.querySelector('select').value;
    else if(n==='refP') p.refP=area.querySelector('select').value;
    else{
      const input = area.querySelector('input');
      if(input) p[n]=Number(input.value);
    }
  });
  return p;
}

/* 事件 */
document.getElementById('addBtn').onclick=()=>addSection();
document.getElementById('goBtn').onclick=()=>{
  const data=collect();
  if(!data) return;
  localStorage.setItem('motionParams',JSON.stringify(data));
  location.href='animate.html';
};

/* 初始：A/B 颜色 + 默认第三点 */
makeColorSelect('A_color',0);
makeColorSelect('B_color',1);
addSection();
</script>
</body>
</html>